const { ethers } = require("hardhat");

async function main() {
    console.log("üîç Verificando implementaci√≥n completa de BrainSafes...\n");

    try {
        // Compilar todos los contratos
        console.log("üì¶ Compilando contratos...");
        await hre.run("compile");
        console.log("‚úÖ Compilaci√≥n exitosa\n");

        // Obtener las f√°bricas de contratos
        const [
            BrainSafesFactory,
            MockEDUTokenFactory,
            MockCourseNFTFactory,
            MockCertificateNFTFactory,
            MockScholarshipManagerFactory,
            MockAIOracleFactory,
            NitroUtilsFactory,
            AddressCompressorFactory,
            EnhancedMulticallFactory,
            DistributedCacheFactory,
            SecurityManagerFactory,
            UserExperienceFactory
        ] = await Promise.all([
            ethers.getContractFactory("BrainSafes"),
            ethers.getContractFactory("MockEDUToken"),
            ethers.getContractFactory("MockCourseNFT"),
            ethers.getContractFactory("MockCertificateNFT"),
            ethers.getContractFactory("MockScholarshipManager"),
            ethers.getContractFactory("MockAIOracle"),
            ethers.getContractFactory("NitroUtils"),
            ethers.getContractFactory("AddressCompressor"),
            ethers.getContractFactory("EnhancedMulticall"),
            ethers.getContractFactory("DistributedCache"),
            ethers.getContractFactory("SecurityManager"),
            ethers.getContractFactory("UserExperience")
        ]);

        // Obtener cuentas
        const [deployer, user1, user2, instructor] = await ethers.getSigners();

        console.log("üöÄ Desplegando contratos mock...");

        // Desplegar contratos mock
        const mockEDUToken = await MockEDUTokenFactory.deploy();
        const mockCourseNFT = await MockCourseNFTFactory.deploy();
        const mockCertificateNFT = await MockCertificateNFTFactory.deploy();
        const mockScholarshipManager = await MockScholarshipManagerFactory.deploy();
        const mockAIOracle = await MockAIOracleFactory.deploy();

        await mockEDUToken.deployed();
        await mockCourseNFT.deployed();
        await mockCertificateNFT.deployed();
        await mockScholarshipManager.deployed();
        await mockAIOracle.deployed();

        console.log("‚úÖ Contratos mock desplegados");

        // Desplegar contratos de utilidades
        const nitroUtils = await NitroUtilsFactory.deploy();
        const addressCompressor = await AddressCompressorFactory.deploy();
        const enhancedMulticall = await EnhancedMulticallFactory.deploy();
        const distributedCache = await DistributedCacheFactory.deploy();
        const securityManager = await SecurityManagerFactory.deploy();
        const userExperience = await UserExperienceFactory.deploy();

        await nitroUtils.deployed();
        await addressCompressor.deployed();
        await enhancedMulticall.deployed();
        await distributedCache.deployed();
        await securityManager.deployed();
        await userExperience.deployed();

        console.log("‚úÖ Contratos de utilidades desplegados");

        // Desplegar BrainSafes
        console.log("üöÄ Desplegando BrainSafes...");
        const brainSafes = await BrainSafesFactory.deploy(
            mockEDUToken.address,
            mockCourseNFT.address,
            mockCertificateNFT.address,
            mockScholarshipManager.address,
            mockAIOracle.address
        );

        await brainSafes.deployed();
        console.log("‚úÖ BrainSafes desplegado en:", brainSafes.address);

        // Configurar contratos de utilidades
        console.log("üîß Configurando contratos de utilidades...");
        await brainSafes.setUtilityContracts(
            nitroUtils.address,
            addressCompressor.address,
            enhancedMulticall.address,
            distributedCache.address,
            securityManager.address,
            userExperience.address
        );
        console.log("‚úÖ Contratos de utilidades configurados");

        // Verificar interfaces
        console.log("\nüîó Verificando interfaces...");
        const eduTokenAddress = await brainSafes.eduToken();
        const courseNFTAddress = await brainSafes.courseNFT();
        const certificateNFTAddress = await brainSafes.certificateNFT();
        const scholarshipManagerAddress = await brainSafes.scholarshipManager();
        const aiOracleAddress = await brainSafes.aiOracle();

        console.log("‚úÖ EDU Token:", eduTokenAddress);
        console.log("‚úÖ Course NFT:", courseNFTAddress);
        console.log("‚úÖ Certificate NFT:", certificateNFTAddress);
        console.log("‚úÖ Scholarship Manager:", scholarshipManagerAddress);
        console.log("‚úÖ AI Oracle:", aiOracleAddress);

        // Verificar contratos de utilidades
        console.log("\nüîß Verificando contratos de utilidades...");
        const nitroUtilsAddress = await brainSafes.nitroUtils();
        const addressCompressorAddress = await brainSafes.addressCompressor();
        const enhancedMulticallAddress = await brainSafes.enhancedMulticall();
        const distributedCacheAddress = await brainSafes.distributedCache();
        const securityManagerAddress = await brainSafes.securityManager();
        const userExperienceAddress = await brainSafes.userExperience();

        console.log("‚úÖ NitroUtils:", nitroUtilsAddress);
        console.log("‚úÖ AddressCompressor:", addressCompressorAddress);
        console.log("‚úÖ EnhancedMulticall:", enhancedMulticallAddress);
        console.log("‚úÖ DistributedCache:", distributedCacheAddress);
        console.log("‚úÖ SecurityManager:", securityManagerAddress);
        console.log("‚úÖ UserExperience:", userExperienceAddress);

        // Probar funciones b√°sicas
        console.log("\nüß™ Probando funciones b√°sicas...");

        // Registrar usuario
        await brainSafes.registerUser("Test User", "test@example.com", "ipfs://profile");
        console.log("‚úÖ Usuario registrado");

        // Registrar instructor
        await brainSafes.registerInstructor(instructor.address);
        console.log("‚úÖ Instructor registrado");

        // Probar funciones de utilidades
        console.log("\nüîß Probando funciones de utilidades...");

        // NitroUtils
        const testData = ethers.utils.toUtf8Bytes("test data");
        const optimizedData = await brainSafes.optimizeGasUsage(testData);
        console.log("‚úÖ NitroUtils - optimizeGasUsage funcionando");

        const compressedData = await brainSafes.compressData(testData);
        console.log("‚úÖ NitroUtils - compressData funcionando");

        // AddressCompressor
        const compressedAddr = await brainSafes.compressAddress(user1.address);
        console.log("‚úÖ AddressCompressor - compressAddress funcionando");

        const decompressedAddr = await brainSafes.decompressAddress(compressedAddr);
        console.log("‚úÖ AddressCompressor - decompressAddress funcionando");

        // DistributedCache
        const cacheKey = ethers.utils.keccak256(ethers.utils.toUtf8Bytes("test"));
        const cacheData = ethers.utils.toUtf8Bytes("cache data");
        await brainSafes.storeInCache(cacheKey, cacheData, Math.floor(Date.now() / 1000) + 3600);
        console.log("‚úÖ DistributedCache - storeInCache funcionando");

        const retrievedData = await brainSafes.getFromCache(cacheKey);
        console.log("‚úÖ DistributedCache - getFromCache funcionando");

        // SecurityManager
        const isBlacklisted = await brainSafes.isBlacklisted(user1.address);
        console.log("‚úÖ SecurityManager - isBlacklisted funcionando");

        // UserExperience
        const userMetrics = await brainSafes.getUserExperienceMetrics(user1.address);
        console.log("‚úÖ UserExperience - getUserExperienceMetrics funcionando");

        // Probar funciones avanzadas
        console.log("\nüöÄ Probando funciones avanzadas...");

        // Batch operations
        const names = ["User1", "User2", "User3"];
        const emails = ["user1@test.com", "user2@test.com", "user3@test.com"];
        const profiles = ["ipfs://1", "ipfs://2", "ipfs://3"];

        await brainSafes.batchRegisterUsers(names, emails, profiles);
        console.log("‚úÖ Batch register users funcionando");

        // Statistics
        const userStats = await brainSafes.getUserStatistics(user1.address);
        console.log("‚úÖ User statistics funcionando");

        const platformStats = await brainSafes.getPlatformStats();
        console.log("‚úÖ Platform statistics funcionando");

        // System health
        const systemHealth = await brainSafes.getSystemHealth();
        console.log("‚úÖ System health funcionando");

        // Performance monitoring
        const performance = await brainSafes.monitorPerformance();
        console.log("‚úÖ Performance monitoring funcionando");

        // Audit trail
        const auditTrail = await brainSafes.getAuditTrail(user1.address);
        console.log("‚úÖ Audit trail funcionando");

        console.log("\nüéâ ¬°Todas las verificaciones completadas exitosamente!");
        console.log("\nüìä Resumen de implementaci√≥n:");
        console.log("‚úÖ Todas las interfaces est√°n correctamente implementadas");
        console.log("‚úÖ Todos los contratos de utilidades est√°n integrados");
        console.log("‚úÖ Todas las funciones b√°sicas est√°n funcionando");
        console.log("‚úÖ Todas las funciones avanzadas est√°n funcionando");
        console.log("‚úÖ Todas las funciones de optimizaci√≥n est√°n funcionando");
        console.log("‚úÖ Todas las funciones de monitoreo est√°n funcionando");

        console.log("\nüîß Configuraci√≥n final:");
        console.log("BrainSafes:", brainSafes.address);
        console.log("EDU Token:", mockEDUToken.address);
        console.log("Course NFT:", mockCourseNFT.address);
        console.log("Certificate NFT:", mockCertificateNFT.address);
        console.log("Scholarship Manager:", mockScholarshipManager.address);
        console.log("AI Oracle:", mockAIOracle.address);

    } catch (error) {
        console.error("‚ùå Error durante la verificaci√≥n:", error);
        process.exit(1);
    }
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error(error);
        process.exit(1);
    });
